# 企业级物资管理系统设计方案

## 1. 项目概述与范围

### 1.1 项目概述
设计一个可扩展到各部门的企业级物资管理系统，支持多公司/多作业区/多仓库管理，具备完整的审批流程、财务对接、审计追溯、库存预警和采购管理功能。

### 1.2 项目范围
**包含范围：**
- 供应商全生命周期管理（新增、维护、考核、停用）
- 物资申请与审批流程
- 采购管理（询价、报价、供应商选择）
- 到货验收与入库管理
- 出库与库存管理
- 财务结算对接
- 多维度报表分析
- 权限管理与审计追溯
- 库存预警与采购建议

**不包含范围：**
- 固定资产管理
- 人力资源管理
- 财务核算系统（仅对接）
- 生产制造管理

### 1.3 技术架构
- **前端：** React + Ant Design + ProComponents + Vite + ECharts
- **后端：** Spring Boot + MyBatis Plus + Redis + RabbitMQ
- **数据库：** MySQL 8.0 + MongoDB（审计日志）
- **部署：** Docker + Kubernetes

## 2. 用户与角色矩阵

| 角色 | 主要职责 | 权限范围 |
|------|----------|----------|
| 系统管理员 | 系统配置、用户管理、权限分配 | 全系统 |
| 集团设备部 | 集采供应商维护、年度考核汇总 | 跨公司供应商管理 |
| 技术总部 | 供应商考核锁定、技术标准制定 | 跨作业区技术管理 |
| 采购员 | 采购计划、询价报价、供应商选择 | 所属公司采购业务 |
| 仓库管理员 | 入库验收、出库管理、库存盘点 | 所属仓库业务 |
| 财务人员 | 发票录入、成本核算、财务报表 | 财务相关数据 |
| 部门申请人 | 物资申请、需求提报 | 个人申请记录 |
| 审批人 | 申请审批、采购审批 | 审批权限范围内 |

## 3. 业务流程与状态机

### 3.1 物资申请流程
```
草稿 → 提交申请 → 部门审批 → 采购审批 → 采购执行 → 完成
  ↓        ↓         ↓         ↓         ↓
撤回    退回修改   退回修改   退回修改    取消
```

**状态定义：**
- DRAFT: 草稿
- SUBMITTED: 已提交
- DEPT_APPROVED: 部门审批通过
- PURCHASE_APPROVED: 采购审批通过
- IN_PROCUREMENT: 采购中
- COMPLETED: 已完成
- REJECTED: 已拒绝
- CANCELLED: 已取消

### 3.2 采购流程
```
创建采购单 → 询价报价 → 供应商选择 → 审批 → 下单 → 到货验收 → 完成
     ↓         ↓         ↓        ↓     ↓       ↓
   修改     重新询价   重新选择   退回  取消   验收不合格
```

### 3.3 入库流程
```
到货验收 → 0元入库 → 发票到达 → 金额调整 → 财务确认 → 完成
    ↓        ↓        ↓        ↓        ↓
  验收退回  修改数量  补录发票  差异说明  财务退回
```

### 3.4 出库流程
```
申请出库 → 审批(可选) → 出库确认 → 实际出库 → 完成
    ↓         ↓         ↓         ↓
  修改申请   审批拒绝   取消出库   出库退回
```

## 4. 数据模型设计

### 4.1 核心实体关系图(ERD)

```
供应商 (suppliers)
├── 供应商考核 (supplier_evaluations)
├── 采购单 (purchase_orders)
└── 到货记录 (arrivals)

物资主数据 (materials)
├── 物资申请明细 (application_details)
├── 采购明细 (purchase_details)
├── 入库明细 (inbound_details)
├── 出库明细 (outbound_details)
└── 库存预警 (inventory_alerts)

仓库 (warehouses)
├── 货位 (locations)
├── 入库单 (inbound_orders)
├── 出库单 (outbound_orders)
└── 库存 (inventory)

申请单 (applications)
├── 申请明细 (application_details)
└── 审批记录 (approval_records)
```

### 4.2 核心表结构

#### 4.2.1 供应商表 (suppliers)
```sql
CREATE TABLE suppliers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    supplier_code VARCHAR(50) NOT NULL UNIQUE COMMENT '供应商编码',
    supplier_name VARCHAR(200) NOT NULL COMMENT '供应商名称',
    social_credit_code VARCHAR(50) UNIQUE COMMENT '统一社会信用代码',
    supply_content TEXT COMMENT '供应内容清单',
    company_address VARCHAR(500) COMMENT '公司地址',
    contact_person VARCHAR(100) COMMENT '联系人',
    contact_phone VARCHAR(50) COMMENT '联系电话',
    business_license VARCHAR(500) COMMENT '营业执照附件',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    company_id BIGINT NOT NULL COMMENT '所属公司ID',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    version INT DEFAULT 1 COMMENT '版本号',
    
    INDEX idx_supplier_code (supplier_code),
    INDEX idx_company_id (company_id),
    INDEX idx_status (status)
) COMMENT '供应商表';
```

#### 4.2.2 供应商考核表 (supplier_evaluations)
```sql
CREATE TABLE supplier_evaluations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    evaluation_year YEAR NOT NULL COMMENT '考核年度',
    supplier_id BIGINT NOT NULL COMMENT '供应商ID',
    work_area_id BIGINT NOT NULL COMMENT '作业区ID',
    service_quality_score DECIMAL(5,2) COMMENT '服务质量评分',
    service_attitude_score DECIMAL(5,2) COMMENT '服务态度评分',
    service_timeliness_score DECIMAL(5,2) COMMENT '服务时效评分',
    total_score DECIMAL(5,2) COMMENT '总分',
    evaluation_result VARCHAR(50) COMMENT '评定结果',
    is_locked BOOLEAN DEFAULT FALSE COMMENT '是否锁定',
    locked_by BIGINT COMMENT '锁定人',
    locked_time DATETIME COMMENT '锁定时间',
    summary_score DECIMAL(5,2) COMMENT '汇总分数',
    summary_time DATETIME COMMENT '汇总时间',
    summary_by BIGINT COMMENT '汇总人',
    
    UNIQUE KEY uk_year_supplier_area (evaluation_year, supplier_id, work_area_id),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    INDEX idx_evaluation_year (evaluation_year),
    INDEX idx_is_locked (is_locked)
) COMMENT '供应商年度考核表';
```

#### 4.2.3 物资主数据表 (materials)
```sql
CREATE TABLE materials (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    material_code VARCHAR(50) NOT NULL UNIQUE COMMENT '物资编码',
    material_name VARCHAR(200) NOT NULL COMMENT '物资名称',
    material_type_id BIGINT NOT NULL COMMENT '物资类型ID',
    specification VARCHAR(500) COMMENT '规格型号',
    unit VARCHAR(20) NOT NULL COMMENT '单位',
    pinyin_code VARCHAR(200) COMMENT '拼音码',
    auxiliary_name VARCHAR(200) COMMENT '辅助命名',
    barcode VARCHAR(100) COMMENT '条形码',
    qr_code VARCHAR(100) COMMENT '二维码',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_material_name (material_name),
    INDEX idx_material_code (material_code),
    INDEX idx_material_type (material_type_id),
    INDEX idx_status (status),
    INDEX idx_pinyin_code (pinyin_code)
) COMMENT '物资主数据表';
```

#### 4.2.4 申请单表 (applications)
```sql
CREATE TABLE applications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    application_no VARCHAR(50) NOT NULL UNIQUE COMMENT '申请单号',
    department_id BIGINT NOT NULL COMMENT '申请部门ID',
    applicant_id BIGINT NOT NULL COMMENT '申请人ID',
    application_date DATE NOT NULL COMMENT '申请日期',
    purpose TEXT COMMENT '用途说明',
    supply_deadline DATE COMMENT '供货期限',
    status ENUM('DRAFT', 'SUBMITTED', 'DEPT_APPROVED', 'PURCHASE_APPROVED', 'IN_PROCUREMENT', 'COMPLETED', 'REJECTED', 'CANCELLED') DEFAULT 'DRAFT' COMMENT '状态',
    workflow_id BIGINT COMMENT '审批流程ID',
    current_approver_id BIGINT COMMENT '当前审批人ID',
    remarks TEXT COMMENT '备注',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_application_no (application_no),
    INDEX idx_department_id (department_id),
    INDEX idx_applicant_id (applicant_id),
    INDEX idx_status (status),
    INDEX idx_application_date (application_date)
) COMMENT '物资申请单表';
```

#### 4.2.5 采购单表 (purchase_orders)
```sql
CREATE TABLE purchase_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    purchase_no VARCHAR(50) NOT NULL UNIQUE COMMENT '采购单号',
    application_date DATE NOT NULL COMMENT '申请日期',
    purchase_type ENUM('NORMAL', 'URGENT', 'CENTRALIZED') DEFAULT 'NORMAL' COMMENT '采购类型',
    purchaser_id BIGINT NOT NULL COMMENT '采购员ID',
    supplier_id BIGINT NOT NULL COMMENT '供应商ID',
    total_amount DECIMAL(15,2) DEFAULT 0 COMMENT '总金额',
    approval_status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'PENDING' COMMENT '审批状态',
    workflow_id BIGINT COMMENT '审批流程ID',
    attachments JSON COMMENT '附件信息',
    remarks TEXT COMMENT '备注',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_purchase_no (purchase_no),
    INDEX idx_supplier_id (supplier_id),
    INDEX idx_approval_status (approval_status),
    INDEX idx_application_date (application_date),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
) COMMENT '采购单表';
```

#### 4.2.6 入库单表 (inbound_orders)
```sql
CREATE TABLE inbound_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    inbound_no VARCHAR(50) NOT NULL UNIQUE COMMENT '入库单号',
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    supplier_id BIGINT NOT NULL COMMENT '供应商ID',
    purchase_order_id BIGINT COMMENT '采购单ID',
    actual_inbound_date DATETIME NOT NULL COMMENT '实际入库日期',
    invoice_inbound_date DATE COMMENT '发票入库日期',
    invoice_no VARCHAR(100) COMMENT '发票编号',
    invoice_date DATE COMMENT '发票日期',
    invoice_amount DECIMAL(15,2) DEFAULT 0 COMMENT '发票金额',
    status ENUM('PENDING', 'CONFIRMED', 'ARCHIVED') DEFAULT 'PENDING' COMMENT '状态',
    warehouse_keeper_id BIGINT NOT NULL COMMENT '仓库管理员ID',
    is_archived BOOLEAN DEFAULT FALSE COMMENT '是否归档',
    period_month VARCHAR(7) NOT NULL COMMENT '期间(YYYY-MM)',
    amount_adjustment_log JSON COMMENT '金额调整日志',
    remarks TEXT COMMENT '备注',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_inbound_no (inbound_no),
    INDEX idx_warehouse_id (warehouse_id),
    INDEX idx_supplier_id (supplier_id),
    INDEX idx_period_month (period_month),
    INDEX idx_actual_inbound_date (actual_inbound_date),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
) COMMENT '入库单表';
```

#### 4.2.7 出库单表 (outbound_orders)
```sql
CREATE TABLE outbound_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    outbound_no VARCHAR(50) NOT NULL UNIQUE COMMENT '出库单号',
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    actual_outbound_date DATETIME NOT NULL COMMENT '实际出库日期',
    invoice_outbound_date DATE COMMENT '发票出库日期',
    status ENUM('PENDING', 'CONFIRMED', 'ARCHIVED') DEFAULT 'PENDING' COMMENT '状态',
    warehouse_keeper_id BIGINT NOT NULL COMMENT '仓库管理员ID',
    is_archived BOOLEAN DEFAULT FALSE COMMENT '是否归档',
    equipment_code VARCHAR(100) COMMENT '使用设备编码',
    usage_type ENUM('PRODUCTION', 'MAINTENANCE', 'OFFICE', 'OTHER') COMMENT '领用类型',
    usage_department_id BIGINT NOT NULL COMMENT '领用部门ID',
    recipient_id BIGINT NOT NULL COMMENT '领用人ID',
    period_month VARCHAR(7) NOT NULL COMMENT '期间(YYYY-MM)',
    remarks TEXT COMMENT '备注',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_outbound_no (outbound_no),
    INDEX idx_warehouse_id (warehouse_id),
    INDEX idx_usage_department_id (usage_department_id),
    INDEX idx_period_month (period_month),
    INDEX idx_actual_outbound_date (actual_outbound_date),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id)
) COMMENT '出库单表';
```

#### 4.2.8 库存表 (inventory)
```sql
CREATE TABLE inventory (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    material_id BIGINT NOT NULL COMMENT '物资ID',
    location_id BIGINT COMMENT '货位ID',
    quantity DECIMAL(15,3) NOT NULL DEFAULT 0 COMMENT '库存数量',
    unit_cost DECIMAL(15,4) DEFAULT 0 COMMENT '单位成本',
    total_cost DECIMAL(15,2) DEFAULT 0 COMMENT '总成本',
    last_inbound_date DATETIME COMMENT '最后入库日期',
    last_outbound_date DATETIME COMMENT '最后出库日期',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_warehouse_material (warehouse_id, material_id),
    INDEX idx_warehouse_id (warehouse_id),
    INDEX idx_material_id (material_id),
    INDEX idx_quantity (quantity),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (material_id) REFERENCES materials(id)
) COMMENT '库存表';
```

#### 4.2.9 库存预警表 (inventory_alerts)
```sql
CREATE TABLE inventory_alerts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_id BIGINT NOT NULL COMMENT '公司ID',
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    material_id BIGINT NOT NULL COMMENT '物资ID',
    min_quantity DECIMAL(15,3) NOT NULL COMMENT '库存下限',
    max_quantity DECIMAL(15,3) NOT NULL COMMENT '库存上限',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_warehouse_material (warehouse_id, material_id),
    INDEX idx_company_id (company_id),
    INDEX idx_warehouse_id (warehouse_id),
    INDEX idx_material_id (material_id),
    CONSTRAINT chk_quantity_range CHECK (min_quantity < max_quantity),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (material_id) REFERENCES materials(id)
) COMMENT '库存预警配置表';
```

## 5. 关键业务规则与校验清单

### 5.1 数据唯一性规则
1. **供应商编码全局唯一**
   - 校验规则：新增/修改时检查supplier_code唯一性
   - 实现：数据库唯一约束 + 应用层校验

2. **物资编码全局唯一**
   - 校验规则：新增/修改时检查material_code唯一性
   - 实现：数据库唯一约束 + 应用层校验

3. **物资名称全局唯一**
   - 校验规则：新增/修改时检查material_name唯一性
   - 实现：数据库唯一约束 + 应用层校验

4. **仓库-物资预警配置唯一**
   - 校验规则：同一仓库同一物资只能有一条预警配置
   - 实现：复合唯一约束(warehouse_id, material_id)

### 5.2 数据不可删除规则
1. **已被引用的供应商不可删除**
   - 校验规则：检查是否存在关联的采购单、入库单
   - 实现：应用层校验 + 外键约束

2. **已被使用的物资不可删除**
   - 校验规则：检查是否存在关联的申请、采购、库存记录
   - 实现：应用层校验，仅允许状态改为INACTIVE

3. **已被使用的仓库不可删除**
   - 校验规则：检查是否存在库存记录、入出库记录
   - 实现：应用层校验，仅允许状态改为INACTIVE

### 5.3 审批流程规则
1. **申请提交后不可撤回**
   - 校验规则：状态为SUBMITTED后，仅当前审批人可退回
   - 实现：状态机控制 + 权限校验

2. **审批路径按金额/类别路由**
   - 校验规则：根据采购金额、物资类别、组织维度确定审批路径
   - 实现：工作流引擎 + 规则配置

### 5.4 期间锁定规则
1. **关账后禁止修改当月数据**
   - 校验规则：检查period_month是否已锁定
   - 实现：期间锁定表 + 应用层校验

2. **解锁需要审批**
   - 校验规则：解锁操作需要财务主管审批
   - 实现：解锁审批流程 + 操作日志

### 5.5 库存预警规则
1. **下限必须小于上限**
   - 校验规则：min_quantity < max_quantity
   - 实现：数据库CHECK约束 + 应用层校验

2. **触发预警条件**
   - 校验规则：当前库存 <= 下限时触发预警
   - 实现：定时任务扫描 + 消息通知

## 6. 配置化与可扩展设计

### 6.1 多公司/多作业区支持
```sql
-- 公司表
CREATE TABLE companies (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_code VARCHAR(50) NOT NULL UNIQUE,
    company_name VARCHAR(200) NOT NULL,
    parent_company_id BIGINT COMMENT '上级公司ID',
    company_type ENUM('GROUP', 'SUBSIDIARY', 'BRANCH') DEFAULT 'SUBSIDIARY',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT '公司组织表';

-- 作业区表
CREATE TABLE work_areas (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    area_code VARCHAR(50) NOT NULL,
    area_name VARCHAR(200) NOT NULL,
    company_id BIGINT NOT NULL,
    area_type ENUM('PRODUCTION', 'OFFICE', 'WAREHOUSE') DEFAULT 'PRODUCTION',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    UNIQUE KEY uk_company_area_code (company_id, area_code),
    FOREIGN KEY (company_id) REFERENCES companies(id)
) COMMENT '作业区表';
```

### 6.2 数据字典配置
```sql
-- 数据字典表
CREATE TABLE system_dictionaries (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    dict_type VARCHAR(100) NOT NULL COMMENT '字典类型',
    dict_code VARCHAR(100) NOT NULL COMMENT '字典编码',
    dict_name VARCHAR(200) NOT NULL COMMENT '字典名称',
    dict_value VARCHAR(500) COMMENT '字典值',
    parent_code VARCHAR(100) COMMENT '父级编码',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    UNIQUE KEY uk_type_code (dict_type, dict_code)
) COMMENT '系统数据字典表';
```

### 6.3 工作流配置
```sql
-- 工作流定义表
CREATE TABLE workflow_definitions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    workflow_code VARCHAR(100) NOT NULL UNIQUE,
    workflow_name VARCHAR(200) NOT NULL,
    business_type ENUM('APPLICATION', 'PURCHASE', 'OUTBOUND') NOT NULL,
    workflow_config JSON NOT NULL COMMENT '流程配置',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT '工作流定义表';

-- 工作流实例表
CREATE TABLE workflow_instances (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    workflow_def_id BIGINT NOT NULL,
    business_id BIGINT NOT NULL COMMENT '业务单据ID',
    business_type ENUM('APPLICATION', 'PURCHASE', 'OUTBOUND') NOT NULL,
    current_node VARCHAR(100) COMMENT '当前节点',
    current_approver_id BIGINT COMMENT '当前审批人',
    status ENUM('RUNNING', 'COMPLETED', 'TERMINATED') DEFAULT 'RUNNING',
    started_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_time DATETIME,
    FOREIGN KEY (workflow_def_id) REFERENCES workflow_definitions(id)
) COMMENT '工作流实例表';
```

## 7. 权限与审计设计

### 7.1 权限模型
```sql
-- 角色表
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_code VARCHAR(100) NOT NULL UNIQUE,
    role_name VARCHAR(200) NOT NULL,
    description TEXT,
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT '角色表';

-- 权限表
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(100) NOT NULL UNIQUE,
    permission_name VARCHAR(200) NOT NULL,
    resource_type VARCHAR(100) NOT NULL COMMENT '资源类型',
    action_type VARCHAR(100) NOT NULL COMMENT '操作类型',
    description TEXT,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT '权限表';

-- 角色权限关联表
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,
    data_scope ENUM('ALL', 'COMPANY', 'DEPARTMENT', 'SELF') DEFAULT 'SELF',
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id)
) COMMENT '角色权限关联表';
```

### 7.2 审计日志
```sql
-- 操作日志表
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '操作用户ID',
    operation_type ENUM('CREATE', 'UPDATE', 'DELETE', 'QUERY', 'APPROVE', 'REJECT') NOT NULL,
    business_type VARCHAR(100) NOT NULL COMMENT '业务类型',
    business_id BIGINT COMMENT '业务ID',
    table_name VARCHAR(100) COMMENT '表名',
    old_data JSON COMMENT '修改前数据',
    new_data JSON COMMENT '修改后数据',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    operation_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_business_type (business_type),
    INDEX idx_operation_time (operation_time)
) COMMENT '审计日志表';
```

## 8. 财务与成本核算方案

### 8.1 0元入库与成本调整方案

#### 方案一：移动加权平均法重估（推荐）
**实现逻辑：**
1. 发票未到时，以0元入库
2. 发票到达后，计算新的加权平均成本
3. 重估历史出库成本，生成成本差异调账单
4. 不影响历史库存数量，仅调整成本

**示例计算：**
```
初始库存：100件 × 10元 = 1000元
0元入库：50件 × 0元 = 0元
出库：30件 × 6.67元 = 200元（按加权平均）
发票到达：50件 × 12元 = 600元

重估后：
- 新加权平均成本：(1000+600)/(100+50) = 10.67元
- 历史出库调整：30件 × (10.67-6.67) = 120元
- 生成成本差异调账单：借：材料成本差异 120元，贷：库存商品 120元
```

**实现表结构：**
```sql
-- 成本调整单表
CREATE TABLE cost_adjustments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    adjustment_no VARCHAR(50) NOT NULL UNIQUE,
    material_id BIGINT NOT NULL,
    warehouse_id BIGINT NOT NULL,
    adjustment_type ENUM('INVOICE_ARRIVAL', 'INVENTORY_REVALUATION') NOT NULL,
    old_unit_cost DECIMAL(15,4) NOT NULL,
    new_unit_cost DECIMAL(15,4) NOT NULL,
    affected_quantity DECIMAL(15,3) NOT NULL,
    adjustment_amount DECIMAL(15,2) NOT NULL,
    invoice_no VARCHAR(100),
    invoice_date DATE,
    period_month VARCHAR(7) NOT NULL,
    status ENUM('PENDING', 'CONFIRMED') DEFAULT 'PENDING',
    created_by BIGINT NOT NULL,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_material_warehouse (material_id, warehouse_id),
    INDEX idx_period_month (period_month)
) COMMENT '成本调整单表';
```

#### 方案二：当期差异处理
**实现逻辑：**
1. 发票未到时，以0元入库
2. 发票到达后，仅对当前库存做差异入账
3. 历史出库不追溯，差额计入当期费用

### 8.2 跨期财务口径处理
```sql
-- 期间锁定表
CREATE TABLE period_locks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_id BIGINT NOT NULL,
    period_month VARCHAR(7) NOT NULL,
    lock_type ENUM('INBOUND', 'OUTBOUND', 'ALL') NOT NULL,
    is_locked BOOLEAN DEFAULT FALSE,
    locked_by BIGINT,
    locked_time DATETIME,
    unlock_reason TEXT,
    unlocked_by BIGINT,
    unlocked_time DATETIME,

    UNIQUE KEY uk_company_period_type (company_id, period_month, lock_type),
    INDEX idx_period_month (period_month),
    INDEX idx_is_locked (is_locked)
) COMMENT '期间锁定表';
```

## 9. 报表与分析设计

### 9.1 核心报表清单

#### 9.1.1 库存查询报表
**字段口径：**
- 库存数量：以实际出入库时间为准
- 库存金额：按最新加权平均成本计算
- 库龄：按最早入库批次计算

**SQL示例：**
```sql
SELECT
    w.warehouse_name,
    m.material_code,
    m.material_name,
    m.specification,
    i.quantity,
    i.unit_cost,
    i.total_cost,
    DATEDIFF(NOW(), i.last_inbound_date) AS inventory_days
FROM inventory i
JOIN warehouses w ON i.warehouse_id = w.id
JOIN materials m ON i.material_id = m.id
WHERE i.quantity > 0
ORDER BY w.warehouse_name, m.material_code;
```

#### 9.1.2 库存预警报表
**字段口径：**
- 预警状态：当前库存 <= 下限为"预警"，> 上限为"超储"
- 建议采购量：上限 - 当前库存（考虑在途数量）

**SQL示例：**
```sql
SELECT
    c.company_name,
    w.warehouse_name,
    m.material_code,
    m.material_name,
    i.quantity AS current_quantity,
    ia.min_quantity,
    ia.max_quantity,
    CASE
        WHEN i.quantity <= ia.min_quantity THEN '预警'
        WHEN i.quantity >= ia.max_quantity THEN '超储'
        ELSE '正常'
    END AS alert_status,
    GREATEST(0, ia.max_quantity - i.quantity) AS suggested_purchase_qty
FROM inventory_alerts ia
JOIN warehouses w ON ia.warehouse_id = w.id
JOIN companies c ON ia.company_id = c.id
JOIN materials m ON ia.material_id = m.id
LEFT JOIN inventory i ON ia.warehouse_id = i.warehouse_id AND ia.material_id = i.material_id
WHERE ia.status = 'ACTIVE'
ORDER BY alert_status DESC, c.company_name, w.warehouse_name;
```

#### 9.1.3 物资出入明细账
**字段口径：**
- 财务报表：按发票日期统计
- 库存报表：按实际出入库时间统计

**SQL示例：**
```sql
-- 入库明细
SELECT
    'IN' AS transaction_type,
    io.inbound_no AS document_no,
    io.actual_inbound_date AS actual_date,
    io.invoice_inbound_date AS financial_date,
    m.material_code,
    m.material_name,
    iod.quantity,
    iod.unit_price,
    iod.amount,
    s.supplier_name
FROM inbound_orders io
JOIN inbound_order_details iod ON io.id = iod.inbound_order_id
JOIN materials m ON iod.material_id = m.id
JOIN suppliers s ON io.supplier_id = s.id

UNION ALL

-- 出库明细
SELECT
    'OUT' AS transaction_type,
    oo.outbound_no AS document_no,
    oo.actual_outbound_date AS actual_date,
    oo.invoice_outbound_date AS financial_date,
    m.material_code,
    m.material_name,
    -ood.quantity AS quantity,
    ood.unit_price,
    -ood.amount AS amount,
    d.department_name AS supplier_name
FROM outbound_orders oo
JOIN outbound_order_details ood ON oo.id = ood.outbound_order_id
JOIN materials m ON ood.material_id = m.id
JOIN departments d ON oo.usage_department_id = d.id

ORDER BY actual_date DESC;
```

#### 9.1.4 财务资金月报
**字段口径：**
- 统计维度：按发票日期
- 金额口径：含税金额

**SQL示例：**
```sql
SELECT
    DATE_FORMAT(io.invoice_inbound_date, '%Y-%m') AS period_month,
    s.supplier_name,
    SUM(io.invoice_amount) AS total_amount,
    COUNT(*) AS order_count,
    AVG(io.invoice_amount) AS avg_amount
FROM inbound_orders io
JOIN suppliers s ON io.supplier_id = s.id
WHERE io.invoice_inbound_date IS NOT NULL
GROUP BY DATE_FORMAT(io.invoice_inbound_date, '%Y-%m'), s.supplier_name
ORDER BY period_month DESC, total_amount DESC;
```

#### 9.1.5 库龄分析报表
**字段口径：**
- 库龄计算：按最早入库批次的入库日期计算
- 分组：0-30天、31-90天、91-180天、181-365天、365天以上

**SQL示例：**
```sql
SELECT
    w.warehouse_name,
    m.material_code,
    m.material_name,
    i.quantity,
    i.total_cost,
    DATEDIFF(NOW(), i.last_inbound_date) AS inventory_days,
    CASE
        WHEN DATEDIFF(NOW(), i.last_inbound_date) <= 30 THEN '0-30天'
        WHEN DATEDIFF(NOW(), i.last_inbound_date) <= 90 THEN '31-90天'
        WHEN DATEDIFF(NOW(), i.last_inbound_date) <= 180 THEN '91-180天'
        WHEN DATEDIFF(NOW(), i.last_inbound_date) <= 365 THEN '181-365天'
        ELSE '365天以上'
    END AS age_group
FROM inventory i
JOIN warehouses w ON i.warehouse_id = w.id
JOIN materials m ON i.material_id = m.id
WHERE i.quantity > 0
ORDER BY inventory_days DESC;
```

## 10. 集成设计

### 10.1 报销系统接口
**接口清单：**

#### 10.1.1 推送采购信息接口
```json
POST /api/reimbursement/purchase-info
{
    "purchaseOrderNo": "PO202401001",
    "purchaseDate": "2024-01-15",
    "supplierCode": "SUP001",
    "supplierName": "XX供应商",
    "totalAmount": 10000.00,
    "purchaserName": "张三",
    "departmentCode": "DEPT001",
    "materials": [
        {
            "materialCode": "MAT001",
            "materialName": "办公用品",
            "quantity": 10,
            "unitPrice": 100.00,
            "amount": 1000.00
        }
    ],
    "approvalRecords": [
        {
            "approverName": "李四",
            "approvalTime": "2024-01-16T10:00:00",
            "approvalResult": "APPROVED",
            "comments": "同意采购"
        }
    ],
    "attachments": [
        {
            "fileName": "采购申请.pdf",
            "fileUrl": "http://file.server.com/files/123.pdf",
            "fileType": "PDF"
        }
    ]
}
```

#### 10.1.2 推送到货信息接口
```json
POST /api/reimbursement/arrival-info
{
    "purchaseOrderNo": "PO202401001",
    "arrivalDate": "2024-01-20",
    "invoiceNo": "INV202401001",
    "invoiceDate": "2024-01-20",
    "invoiceAmount": 10000.00,
    "materials": [
        {
            "materialCode": "MAT001",
            "arrivedQuantity": 10,
            "qualityStatus": "QUALIFIED"
        }
    ]
}
```

### 10.2 报价平台接口
```json
POST /api/quotation/inquiry
{
    "inquiryNo": "INQ202401001",
    "inquiryDate": "2024-01-15",
    "materials": [
        {
            "materialCode": "MAT001",
            "materialName": "办公用品",
            "specification": "A4纸",
            "quantity": 100,
            "expectedDeliveryDate": "2024-01-30"
        }
    ],
    "suppliers": ["SUP001", "SUP002", "SUP003"]
}
```

### 10.3 条码扫描接口
```json
POST /api/barcode/scan
{
    "barcodeData": "MAT001|LOT20240115|100",
    "scanType": "INBOUND|OUTBOUND",
    "warehouseCode": "WH001",
    "operatorId": 1001
}
```

## 11. 非功能需求与运维

### 11.1 性能指标
- **响应时间：** 页面加载 < 2秒，查询响应 < 1秒
- **并发量：** 支持500并发用户
- **数据量：** 支持千万级数据记录
- **可用性：** 99.9%系统可用性

### 11.2 数据库优化策略
```sql
-- 分区表示例（按月分区）
CREATE TABLE audit_logs_2024 (
    -- 字段定义同audit_logs表
) PARTITION BY RANGE (MONTH(operation_time)) (
    PARTITION p202401 VALUES LESS THAN (2),
    PARTITION p202402 VALUES LESS THAN (3),
    -- ... 其他月份分区
    PARTITION p202412 VALUES LESS THAN (13)
);

-- 索引优化
CREATE INDEX idx_composite_inventory ON inventory(warehouse_id, material_id, quantity);
CREATE INDEX idx_period_status ON inbound_orders(period_month, status);
```

### 11.3 缓存策略
```yaml
# Redis缓存配置
cache:
  # 渠道管理
  master_data:
    ttl: 86400
    keys:
      - "materials:*"
      - "suppliers:*"
      - "warehouses:*"

  # 库存数据缓存（1小时）
  inventory:
    ttl: 3600
    keys:
      - "inventory:warehouse:*"
      - "inventory:alerts:*"

  # 用户权限缓存（30分钟）
  permissions:
    ttl: 1800
    keys:
      - "user:permissions:*"
```

### 11.4 监控与告警
```yaml
# 监控指标
monitoring:
  # 系统指标
  system:
    - cpu_usage > 80%
    - memory_usage > 85%
    - disk_usage > 90%

  # 应用指标
  application:
    - response_time > 2000ms
    - error_rate > 1%
    - active_connections > 1000

  # 业务指标
  business:
    - pending_approvals > 100
    - inventory_alerts > 50
    - failed_integrations > 10
```

## 12. 风险与边界

### 12.1 技术风险
1. **数据一致性风险**
   - 风险：并发操作导致库存数据不一致
   - 缓解：使用分布式锁、事务控制

2. **性能风险**
   - 风险：大数据量查询导致系统响应慢
   - 缓解：分页查询、索引优化、读写分离

3. **集成风险**
   - 风险：外部系统接口不稳定
   - 缓解：重试机制、熔断器、降级策略

### 12.2 业务风险
1. **审批流程风险**
   - 风险：审批人员变更导致流程中断
   - 缓解：代理人机制、超时自动流转

2. **成本核算风险**
   - 风险：发票延迟导致成本核算不准确
   - 缓解：预估成本机制、定期对账

### 12.3 未决事项与建议
1. **成本核算方法选择**
   - 建议：采用移动加权平均法，便于成本追溯
   - 权衡：实现复杂度 vs 财务准确性

2. **审批流程配置**
   - 建议：采用可视化流程设计器
   - 权衡：开发成本 vs 业务灵活性

3. **数据归档策略**
   - 建议：历史数据按年归档，保留3年在线数据
   - 权衡：存储成本 vs 查询性能

## 13. 验收标准与测试

### 13.1 关键用例测试
#### 13.1.1 物资申请流程测试
```
测试场景：完整的物资申请审批流程
前置条件：
1. 用户已登录系统
2. 已配置审批流程
3. 物资主数据已维护

测试步骤：
1. 创建物资申请单
2. 添加申请明细
3. 提交申请
4. 部门审批
5. 采购审批
6. 验证状态变更

预期结果：
- 申请单状态正确流转
- 审批记录完整保存
- 通知消息正确发送
```

#### 13.1.2 0元入库与成本调整测试
```
测试场景：发票延迟到达的成本处理
前置条件：
1. 已有采购单
2. 货物已到达但发票未到

测试步骤：
1. 执行0元入库
2. 部分出库操作
3. 发票到达，录入发票信息
4. 系统自动计算成本调整
5. 生成成本调整单

预期结果：
- 0元入库成功
- 出库按临时成本计算
- 发票到达后成本重估正确
- 历史出库成本调整准确
```

### 13.2 边界用例测试
#### 13.2.1 并发库存扣减测试
```
测试场景：多用户同时出库同一物资
测试数据：库存100件，5个用户同时申请出库30件

预期结果：
- 只有前3个用户出库成功
- 后2个用户提示库存不足
- 最终库存为10件
- 无超卖现象
```

#### 13.2.2 期间锁定测试
```
测试场景：财务关账后的数据修改限制
测试步骤：
1. 财务人员执行关账操作
2. 用户尝试修改当月入库单
3. 用户尝试新增当月出库单

预期结果：
- 关账操作成功
- 修改当月数据被拒绝
- 系统提示期间已锁定
```

### 13.3 UAT场景设计
#### 13.3.1 日常业务场景
1. **采购员日常工作流**
   - 查看待处理申请
   - 创建采购单
   - 询价比价
   - 选择供应商
   - 提交审批

2. **仓库管理员日常工作流**
   - 扫码入库
   - 货位分配
   - 扫码出库
   - 库存盘点
   - 预警处理

3. **财务人员日常工作流**
   - 发票录入
   - 成本核对
   - 月度关账
   - 报表生成

#### 13.3.2 异常处理场景
1. **供应商变更处理**
   - 供应商信息修改
   - 供应商停用
   - 历史数据保护

2. **审批流程异常**
   - 审批人离职
   - 审批超时
   - 流程回退

### 13.4 数据初始化与迁移策略
#### 13.4.1 渠道管理
```sql
-- 初始化公司组织数据
INSERT INTO companies (company_code, company_name, company_type) VALUES
('GROUP', '集团总部', 'GROUP'),
('SUB001', '子公司A', 'SUBSIDIARY'),
('SUB002', '子公司B', 'SUBSIDIARY');

-- 初始化数据字典
INSERT INTO system_dictionaries (dict_type, dict_code, dict_name) VALUES
('MATERIAL_TYPE', 'OFFICE', '办公用品'),
('MATERIAL_TYPE', 'EQUIPMENT', '设备器材'),
('MATERIAL_TYPE', 'CONSUMABLE', '消耗品');

-- 初始化角色权限
INSERT INTO roles (role_code, role_name) VALUES
('ADMIN', '系统管理员'),
('PURCHASER', '采购员'),
('WAREHOUSE_KEEPER', '仓库管理员'),
('FINANCE', '财务人员');
```

#### 13.4.2 历史数据迁移
```python
# 数据迁移脚本示例
def migrate_legacy_data():
    # 1. 供应商数据迁移
    migrate_suppliers()

    # 2. 物资主数据迁移
    migrate_materials()

    # 3. 库存数据迁移
    migrate_inventory()

    # 4. 历史交易记录迁移
    migrate_transactions()

    # 5. 数据校验
    validate_migrated_data()

def migrate_suppliers():
    """迁移供应商数据"""
    legacy_suppliers = get_legacy_suppliers()
    for supplier in legacy_suppliers:
        new_supplier = {
            'supplier_code': generate_supplier_code(supplier),
            'supplier_name': supplier['name'],
            'social_credit_code': supplier['tax_id'],
            'status': 'ACTIVE' if supplier['is_active'] else 'INACTIVE'
        }
        insert_supplier(new_supplier)
```

## 14. 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 物资 | Material | 企业生产经营活动中需要的各种物品，包括原材料、设备、办公用品等 |
| 供应商 | Supplier | 向企业提供物资或服务的外部组织或个人 |
| 库存 | Inventory | 企业在仓库中储存的物资数量和价值 |
| 入库 | Inbound | 物资进入仓库的过程，包括验收、登记、上架等环节 |
| 出库 | Outbound | 物资从仓库发出的过程，包括拣货、复核、发货等环节 |
| 货位 | Location | 仓库中存放物资的具体位置，如货架、货区等 |
| 库龄 | Inventory Age | 物资在仓库中存放的时间长度 |
| 预警 | Alert | 当库存数量低于或高于设定阈值时的提醒机制 |
| 审批流 | Workflow | 业务单据按照预定规则进行审核批准的流程 |
| 期间锁定 | Period Lock | 财务关账后禁止修改该期间数据的控制机制 |
| 成本重估 | Cost Revaluation | 根据最新成本信息调整库存和历史交易成本的过程 |
| 移动加权平均 | Moving Weighted Average | 根据入库数量和金额计算平均成本的方法 |

## 15. 项目实施计划

### 15.1 里程碑计划
| 阶段 | 时间 | 主要交付物 | 参与角色 |
|------|------|-----------|----------|
| 需求澄清 | 2周 | 详细需求文档、原型设计 | 产品经理、业务专家、开发团队 |
| 系统设计 | 2周 | 技术架构、数据库设计、接口设计 | 架构师、开发团队 |
| 开发阶段1 | 4周 | 渠道管理 | 开发团队、测试团队 |
| 开发阶段2 | 4周 | 申请审批、采购管理 | 开发团队、测试团队 |
| 开发阶段3 | 4周 | 入出库管理、库存管理 | 开发团队、测试团队 |
| 开发阶段4 | 3周 | 财务对接、报表分析 | 开发团队、测试团队 |
| 系统集成 | 2周 | 接口联调、集成测试 | 开发团队、测试团队、外部系统团队 |
| UAT测试 | 3周 | 用户验收测试、问题修复 | 业务用户、测试团队、开发团队 |
| 试运行 | 4周 | 生产环境部署、试运行 | 运维团队、业务用户 |
| 正式上线 | 1周 | 系统上线、培训支持 | 全体团队 |
| 项目回顾 | 1周 | 项目总结、经验分享 | 项目团队 |

### 15.2 最小可行产品(MVP)建议
**第一期MVP范围：**
1. **渠道管理**
   - 供应商管理（新增、修改、停用）
   - 物资主数据管理
   - 仓库货位管理

2. **核心业务流程**
   - 物资申请与审批
   - 简化采购流程（手工询价）
   - 基础入出库管理

3. **基础报表**
   - 库存查询
   - 出入库明细
   - 简单统计报表

**第二期扩展功能：**
1. 供应商考核管理
2. 库存预警与采购建议
3. 财务对接与成本核算
4. 高级报表与分析

**第三期完善功能：**
1. 外部系统集成
2. 条码扫描
3. 移动端应用
4. 高级工作流配置

### 15.3 技术债务管理
1. **代码质量**
   - 代码审查机制
   - 单元测试覆盖率 > 80%
   - 代码重构计划

2. **性能优化**
   - 数据库查询优化
   - 缓存策略实施
   - 前端性能监控

3. **安全加固**
   - 安全漏洞扫描
   - 权限控制完善
   - 数据加密实施

---

**总结：**
本方案提供了一个完整的企业级物资管理系统设计，涵盖了从需求分析到实施部署的全过程。系统采用现代化的技术架构，支持多公司、多仓库的复杂业务场景，具备良好的可扩展性和可维护性。通过分阶段实施，可以快速交付MVP版本，然后逐步完善功能，最终建成一个功能完备、性能优良的物资管理系统。
```
```
